<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å—æ²™æ”¿ç­– AI åŠ©æ‰‹ - èŠå¤©</title>
  <style>
    :root {
      --primary-color: #0066ff;
      --secondary-color: #00d4ff;
      --accent-color: #ff6b6b;
      --text-dark: #1a1a2e;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --gradient-primary: linear-gradient(135deg, #0066ff 0%, #00d4ff 100%);
      --shadow-heavy: 0 20px 40px rgba(0, 0, 0, 0.15);
      --glow: 0 0 30px rgba(0, 212, 255, 0.3);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }

    body {
      background: #ffffff;
      display: flex; flex-direction: column; position: relative;
    }

    /* å…¨å±æ‰¿è½½å®¹å™¨ */
    .chat-fullscreen {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      width: 100%; height: 100%; z-index: 1; background: var(--bg-primary);
    }
    .chat-fullscreen iframe {
      width: 100% !important; height: 100% !important; border: 0;
      border-radius: 0 !important; box-shadow: none !important;
    }

    /* SDK æ³¨å…¥çš„æµ®çª—/é¢æ¿å¼ºåˆ¶å…¨å±æ˜¾ç¤ºï¼ˆå…œåº•è¦†ç›–ï¼‰ */
    iframe[src*="coze"],
    iframe[src*="chat-app-sdk"],
    .coze-web-sdk,
    .coze-chat,
    .chatbot-window,
    .coze-dialog,
    .coze-overlay,
    [class*="coze"][class*="chat"] {
      position: fixed !important;
      top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important;
      width: 100% !important; height: 100% !important;
      max-width: none !important; max-height: none !important;
      border-radius: 0 !important; box-shadow: none !important;
    }

    body::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="circuit" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M10,10 L90,10 L90,90 L10,90 Z M30,30 L70,30 M30,50 L70,50 M30,70 L70,70" fill="none" stroke="rgba(0,212,255,0.1)" stroke-width="1"/><circle cx="20" cy="20" r="2" fill="rgba(0,212,255,0.2)"/><circle cx="80" cy="80" r="2" fill="rgba(255,107,107,0.2)"/></pattern></defs><rect width="100%" height="100%" fill="url(%23circuit)"/></svg>');
      display: none;
    }

    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }

    .loading-container {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, var(--text-dark) 0%, #1a1a2e 50%, #16213e 100%);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 9999; transition: opacity 0.5s ease;
    }

    .loading-logo {
      width: 100px; height: 100px; background: rgba(0, 212, 255, 0.1);
      border: 2px solid rgba(0, 212, 255, 0.3); border-radius: 50%;
      display: flex; align-items: center; justify-content: center; margin-bottom: 30px;
      animation: pulse 2s infinite; backdrop-filter: blur(10px); box-shadow: var(--glow);
    }
    .loading-logo::before { content: "ğŸ¤–"; font-size: 50px; }

    .loading-text { color: white; font-size: 22px; font-weight: 600; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .loading-subtitle { color: rgba(255, 255, 255, 0.8); font-size: 16px; font-weight: 400; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 1; box-shadow: var(--glow); } 50% { transform: scale(1.1); opacity: 0.7; box-shadow: 0 0 50px rgba(0, 212, 255, 0.5); } 100% { transform: scale(1); opacity: 1; box-shadow: var(--glow); } }

    .error-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--accent-color) 0%, #ee5a24 100%); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9998; color: white; text-align: center; padding: 20px; }
    .error-icon { font-size: 80px; margin-bottom: 30px; animation: shake 0.5s ease-in-out infinite alternate; }
    @keyframes shake { 0% { transform: translateX(0); } 100% { transform: translateX(5px); } }
    .error-title { font-size: 24px; font-weight: bold; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }
    .error-message { font-size: 16px; opacity: 0.9; line-height: 1.6; font-weight: 400; }

    @media (max-width: 768px) {
      .loading-logo { width: 80px; height: 80px; }
      .loading-logo::before { font-size: 40px; }
      .loading-text { font-size: 18px; }
      .loading-subtitle { font-size: 14px; }
      .error-icon { font-size: 60px; }
      .error-title { font-size: 20px; }
      .error-message { font-size: 14px; }
    }
  </style>
</head>
<body>
  <!-- å…¨å±èŠå¤©æ‰¿è½½å®¹å™¨ -->
  <div id="chatContainer" class="chat-fullscreen"></div>
  <!-- åŠ è½½ç•Œé¢ -->
  <div class="loading-container" id="loadingContainer">
    <div class="loading-logo"></div>
    <div class="loading-text">æ­£åœ¨è¿›å…¥èŠå¤©...</div>
    <div class="loading-subtitle">æ”¿ç­–ä¿¡æ¯è¯¢é—®åŠ©æ‰‹</div>
  </div>

  <!-- é”™è¯¯ç•Œé¢ -->
  <div class="error-container" id="errorContainer">
    <div class="error-icon">âš ï¸</div>
    <div class="error-title">è¿æ¥å¤±è´¥</div>
    <div class="error-message" id="errorMessage">æ— æ³•è¿æ¥åˆ°èŠå¤©æœåŠ¡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•</div>
  </div>

  <script>
    // é…ç½®ï¼šä½¿ç”¨æ‚¨çš„ BOT IDï¼ˆä»¤ç‰Œå°†ä»æœåŠ¡ç«¯è·å–ï¼‰
    const COZE_CONFIG = { botId: '7551607906198700058' };

    let chatClient = null;
    let ACCESS_TOKEN = null;
    let TOKEN_TYPE = null;
    let API_BASE = null; // è¿œç¨‹åç«¯åŸºå€ï¼ˆç”¨äº GitHub Pages ç­‰çº¯å‰ç«¯ç¯å¢ƒï¼‰

    function showError(detail) {
      document.getElementById('loadingContainer').style.display = 'none';
      const msgEl = document.getElementById('errorMessage');
      if (detail) {
        try {
          let text = typeof detail === 'string' ? detail : (detail && detail.message) || JSON.stringify(detail);
          // è„±æ•ï¼šéšè—å¯èƒ½å‡ºç°çš„ä»¤ç‰Œå†…å®¹
          text = text.replace(/pat_[A-Za-z0-9]+/g, 'pat_********');
          text = text.replace(/(access_token"\s*:\s*")[^"]+(")/gi, '$1********$2');
          msgEl.textContent = `é”™è¯¯è¯¦æƒ…ï¼š${text}`;
        } catch(e) {}
      }
      document.getElementById('errorContainer').style.display = 'flex';
    }

    function hideLoading() {
      const loadingContainer = document.getElementById('loadingContainer');
      loadingContainer.style.opacity = '0';
      setTimeout(() => { loadingContainer.style.display = 'none'; }, 500);
    }

    async function initCozeSDK() {
      try {
        if (typeof window.CozeWebSDK === 'undefined') {
          throw new Error('CozeWebSDK æœªåŠ è½½');
        }

        // æ ¹æ®è¿è¡Œç¯å¢ƒé€‰æ‹©ä»¤ç‰Œè·å–æ–¹å¼ï¼š
        // - è‹¥é…ç½®æä¾› backend_baseï¼ˆæˆ– URL å‚æ•° ?api=ï¼‰ï¼Œä¼˜å…ˆèµ°è¿œç¨‹åç«¯ API
        // - Pages ä¸”æ— åç«¯ï¼šä½¿ç”¨å‰ç«¯ PAT ç›´è¿
        // - æœ¬åœ°ï¼šä½¿ç”¨åŒæºåç«¯ /token
        async function getTokenByEnv() {
          const isPages = /github\.io$/i.test(window.location.hostname);
          try {
            const cfgResp = await fetch('coze_oauth_config.json', { cache: 'no-cache' });
            if (cfgResp.ok) {
              const cfg = await cfgResp.json();
              const qpApi = new URLSearchParams(window.location.search).get('api');
              API_BASE = (qpApi || cfg.backend_base || '').trim() || null;
              // åœ¨ Pages æˆ–å…¶ä»–å‰ç«¯ç¯å¢ƒï¼Œå¦‚æä¾›äº†åç«¯åŸºå€ï¼Œåˆ™è°ƒç”¨è¿œç¨‹åç«¯
              if (API_BASE) {
                const tokenResp = await fetch(`${API_BASE}/token`, { credentials: 'include' });
                if (tokenResp.ok) return tokenResp.json();
                console.warn('è¿œç¨‹åç«¯è·å– token å¤±è´¥ï¼Œå›é€€å‰ç«¯æ¨¡å¼');
              }
              // æ— åç«¯æ—¶ï¼Œå°è¯•ä½¿ç”¨ PAT
              if (isPages) {
                const pat = (cfg && (cfg.websdk_pat || cfg.pat) || '').trim();
                if (pat) return { token_type: 'pat', access_token: pat };
                throw new Error('Pages ç¯å¢ƒç¼ºå°‘ websdk_patï¼Œæ— æ³•è·å–ä»¤ç‰Œ');
              }
            }
          } catch(e) {
            console.warn('è¯»å–é…ç½®æˆ–è¿œç¨‹åç«¯å¤±è´¥:', e);
          }
          // æœ¬åœ°åŒæºåç«¯
          const tokenResp = await fetch('/token', { credentials: 'include' });
          if (!tokenResp.ok) { window.location.href = '/login'; return null; }
          return tokenResp.json();
        }

        const tokenData = await getTokenByEnv();
        ACCESS_TOKEN = tokenData && tokenData.access_token;
        TOKEN_TYPE = (tokenData && tokenData.token_type) || 'pkce';

        chatClient = new window.CozeWebSDK.WebChatClient({
          // ä½¿ç”¨ iframe åµŒå…¥åˆ°å…¨å±å®¹å™¨ï¼Œé¿å…å°æµ®çª—
          config: { botId: COZE_CONFIG.botId, isIframe: true },
          auth: {
            type: 'token',
            token: ACCESS_TOKEN,
            onRefreshToken: async () => {
              // PAT ä¸éœ€è¦åˆ·æ–°ï¼Œç›´æ¥è¿”å›å½“å‰ä»¤ç‰Œ
              if (TOKEN_TYPE === 'pat') { return ACCESS_TOKEN; }
              try {
                const url = API_BASE ? `${API_BASE}/refresh_token` : '/refresh_token';
                const resp = await fetch(url, {
                  method: 'POST',
                  credentials: 'include',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({})
                });
                if (!resp.ok) throw new Error('åˆ·æ–°ä»¤ç‰Œå¤±è´¥');
                const data = await resp.json();
                ACCESS_TOKEN = data.access_token;
                return ACCESS_TOKEN;
              } catch (e) {
                console.error('åˆ·æ–°ä»¤ç‰Œå¤±è´¥:', e);
                // PAT æ¨¡å¼ä¸åˆ·æ–°ï¼›OAuth åˆ·æ–°å¤±è´¥åˆ™å›åˆ°ç™»å½•ï¼ˆä»…åœ¨æœ‰åç«¯æ—¶ï¼‰
                const isPages = /github\.io$/i.test(window.location.hostname);
                if (TOKEN_TYPE !== 'pat') {
                  const loginUrl = API_BASE ? `${API_BASE}/login` : (isPages ? null : '/login');
                  if (loginUrl) window.location.href = loginUrl;
                }
                throw e;
              }
            }
          },
          userInfo: { id: 'user_' + Date.now(), url: '', nickname: 'è®¿å®¢' },
          ui: {
            // æ§åˆ¶å°é£æ ¼ï¼šPC å¸ƒå±€ + ä¼šè¯æ  + ä¸Šä¼  + è¯­éŸ³
            base: { layout: 'pc', lang: 'zh-CN', zIndex: 2 },
            asstBtn: { isNeed: false },
            header: { isShow: true },
            chatBot: {
              title: 'æ”¿ç­–æ•ˆèƒ½å°æ‰‹',
              welcomeMessage: 'æ‚¨å¥½ï¼æˆ‘æ˜¯å—æ²™æ”¿ç­– AI åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚',
              uploadable: true,
              isNeedAddNewConversation: true,
              isNeedAudio: true
            },
            footer: { isShow: true, expressionText: 'AIç”Ÿæˆå†…å®¹ï¼Œè¯·ä»”ç»†ç”„åˆ«' },
            conversations: { isNeed: true }
          }
        });

        function forceFullscreen() {
          try {
            const container = document.getElementById('chatContainer');
            const iframes = Array.from(document.getElementsByTagName('iframe'));
            const cozeIframe = iframes.find(f => /coze|chat-app-sdk|flow-platform/i.test(f.src || ''));
            if (cozeIframe && container && cozeIframe.parentElement !== container) {
              container.appendChild(cozeIframe);
            }
            const overlays = Array.from(document.querySelectorAll('div'))
              .filter(d => /coze|chat|dialog|overlay/i.test(d.className || ''));
            overlays.forEach(d => {
              d.style.position = 'fixed';
              d.style.top = '0'; d.style.left = '0'; d.style.right = '0'; d.style.bottom = '0';
              d.style.width = '100%'; d.style.height = '100%';
              d.style.borderRadius = '0'; d.style.boxShadow = 'none';
            });
          } catch (e) { console.warn('å¼ºåˆ¶å…¨å±å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰:', e); }
        }

        if (chatClient && typeof chatClient.showChatBot === 'function') {
          chatClient.showChatBot();
          forceFullscreen();
          hideLoading();
        }

        if (chatClient && typeof chatClient.on === 'function') {
          chatClient.on('ready', function() {
            console.log('Chat SDK åˆå§‹åŒ–æˆåŠŸ');
            hideLoading();
            // ä¿æŒé»˜è®¤ï¼Œä¸è‡ªåŠ¨æ–°å»ºä¼šè¯
            chatClient.showChatBot && chatClient.showChatBot();
            forceFullscreen();
          });
          chatClient.on('error', function(error) {
            console.error('Chat SDK é”™è¯¯:', error);
            showError(error);
          });
      }
    } catch (error) {
      console.error('Chat SDK åˆå§‹åŒ–å¤±è´¥:', error);
      showError(error);
    }
  }

    function loadCozeSDK() {
      return new Promise((resolve, reject) => {
        if (window.CozeWebSDK) { resolve(); return; }
        const script = document.createElement('script');
        script.src = 'https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.2.0-beta.19/libs/cn/index.js';
        script.onload = () => { console.log('Coze SDK åŠ è½½æˆåŠŸ'); resolve(); };
        script.onerror = () => { console.error('Coze SDK åŠ è½½å¤±è´¥'); reject(new Error('SDK åŠ è½½å¤±è´¥')); };
        document.head.appendChild(script);
      });
    }

    // å°è¯•æ¸…ç†æ—§ç‰ˆ SDK çš„æœ¬åœ°ç¼“å­˜ï¼Œé¿å…è·¨ç”¨æˆ·æ¢å¤æ—§ä¼šè¯å¯¼è‡´æƒé™é”™è¯¯
    function forceClearAllCaches() {
      try { if (localStorage && typeof localStorage.clear === 'function') localStorage.clear(); } catch(e) {}
      try { if (sessionStorage && typeof sessionStorage.clear === 'function') sessionStorage.clear(); } catch(e) {}
    }
    function clearCozeCache() {
      try {
        const lkeys = Object.keys(localStorage || {});
        lkeys.forEach(k => { if (/coze|conversation|chat|flow|sdk/i.test(k)) localStorage.removeItem(k); });
      } catch(e) {}
      try {
        const skeys = Object.keys(sessionStorage || {});
        skeys.forEach(k => { if (/coze|conversation|chat|flow|sdk/i.test(k)) sessionStorage.removeItem(k); });
      } catch(e) {}
    }

    document.addEventListener('DOMContentLoaded', async function() {
      try {
        forceClearAllCaches();
        clearCozeCache();
        await loadCozeSDK();
        await initCozeSDK();
      } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        showError(error);
      }
    });

    window.addEventListener('error', function(e) {
      console.error('é¡µé¢é”™è¯¯:', e.error);
      showError();
    });
  </script>
</body>
</html>